name: Deploy to AWS Lightsail

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  LIGHTSAIL_INSTANCE_NAME: my-app-instance
  NODE_VERSION: '18'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: app/package-lock.json

    - name: Install dependencies
      working-directory: ./app
      run: npm ci

    - name: Run tests
      working-directory: ./app
      run: npm test

    - name: Build application
      working-directory: ./app
      run: npm run build

  deploy-infrastructure:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    outputs:
      instance_ip: ${{ steps.get-ip.outputs.instance_ip }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.5.0

    - name: Terraform Init
      working-directory: ./terraform
      run: terraform init

    - name: Clean up existing resources
      working-directory: ./terraform
      run: |
        # Check if resources exist and clean them up
        echo "Checking for existing resources..."
        
        # Delete existing key pair if it exists
        aws lightsail delete-key-pair --key-pair-name "${{ env.LIGHTSAIL_INSTANCE_NAME }}-key" || echo "Key pair doesn't exist or already deleted"
        
        # Delete existing static IP if it exists
        aws lightsail release-static-ip --static-ip-name "${{ env.LIGHTSAIL_INSTANCE_NAME }}-static-ip" || echo "Static IP doesn't exist or already deleted"
        
        # Delete existing instance if it exists
        aws lightsail delete-instance --instance-name "${{ env.LIGHTSAIL_INSTANCE_NAME }}" || echo "Instance doesn't exist or already deleted"
        
        # Wait a moment for resources to be fully deleted
        sleep 30

    - name: Terraform Plan
      working-directory: ./terraform
      run: terraform plan -out=tfplan

    - name: Terraform Apply
      working-directory: ./terraform
      run: terraform apply -auto-approve tfplan

    - name: Get Lightsail instance IP
      id: get-ip
      run: |
        INSTANCE_IP=$(aws lightsail get-instance --instance-name ${{ env.LIGHTSAIL_INSTANCE_NAME }} --query 'instance.publicIpAddress' --output text)
        echo "instance_ip=$INSTANCE_IP" >> $GITHUB_OUTPUT
        echo "Instance IP: $INSTANCE_IP"

    - name: Wait for instance to be ready
      run: |
        echo "Waiting for instance to be ready..."
        sleep 120
        
        # Wait for instance to be running and accessible
        for i in {1..30}; do
          INSTANCE_STATE=$(aws lightsail get-instance --instance-name ${{ env.LIGHTSAIL_INSTANCE_NAME }} --query 'instance.state.name' --output text)
          if [ "$INSTANCE_STATE" = "running" ]; then
            echo "Instance is running!"
            break
          fi
          echo "Waiting for instance to be running... ($i/30) Current state: $INSTANCE_STATE"
          sleep 10
        done
        
        # Wait for user_data script to complete using run command
        echo "Waiting for user_data script to complete..."
        for i in {1..20}; do
          COMMAND_ID=$(aws lightsail send-instance-access-details --instance-name ${{ env.LIGHTSAIL_INSTANCE_NAME }} --protocol ssh --query 'accessDetails.instanceName' --output text 2>/dev/null || echo "")
          if [ -n "$COMMAND_ID" ]; then
            # Test if we can run a simple command
            RESULT=$(aws lightsail get-instance-access-details --instance-name ${{ env.LIGHTSAIL_INSTANCE_NAME }} --query 'accessDetails.ipAddress' --output text 2>/dev/null || echo "")
            if [ -n "$RESULT" ]; then
              echo "Instance access is ready!"
              break
            fi
          fi
          echo "Waiting for instance access... ($i/20)"
          sleep 15
        done
        
        echo "Instance is ready for deployment"

  deploy-application:
    needs: [test, deploy-infrastructure]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup Python environment
      run: |
        python3 -m pip install --upgrade pip
        python3 -m pip install boto3

    - name: Deploy application to Lightsail
      env:
        INSTANCE_IP: ${{ needs.deploy-infrastructure.outputs.instance_ip }}
        GITHUB_SHA: ${{ github.sha }}
        GITHUB_REF_NAME: ${{ github.ref_name }}
        GITHUB_WORKFLOW: ${{ github.workflow }}
        GITHUB_RUN_ID: ${{ github.run_id }}
        GITHUB_ACTOR: ${{ github.actor }}
      run: |
        # Create deployment package
        tar -czf app.tar.gz app/
        
        # Prepare environment variables for deployment
        ENV_VARS=$(cat << 'ENVJSON'
        {
          "NODE_ENV": "production",
          "PORT": "3000",
          "DEPLOY_TIME": "$(date -u +\"%Y-%m-%dT%H:%M:%SZ\")",
          "GITHUB_SHA": "${{ github.sha }}",
          "GITHUB_REF_NAME": "${{ github.ref_name }}",
          "GITHUB_WORKFLOW": "${{ github.workflow }}",
          "GITHUB_RUN_ID": "${{ github.run_id }}",
          "GITHUB_ACTOR": "${{ github.actor }}"
        }
        ENVJSON
        )
        
        # Deploy using Python script with run commands
        python3 deploy-with-run-command.py "${{ env.LIGHTSAIL_INSTANCE_NAME }}" "app.tar.gz" "$ENV_VARS"

    - name: Health check
      env:
        INSTANCE_IP: ${{ needs.deploy-infrastructure.outputs.instance_ip }}
      run: |
        echo "Performing health check..."
        
        # Wait for application to fully start
        sleep 15
        
        # Check health endpoint
        for i in {1..10}; do
          if curl -f -s http://$INSTANCE_IP/health; then
            echo "âœ… Health check passed!"
            break
          elif [ $i -eq 10 ]; then
            echo "âŒ Health check failed after 10 attempts"
            exit 1
          else
            echo "Health check attempt $i/10 failed, retrying in 10 seconds..."
            sleep 10
          fi
        done
        
        # Test main endpoint
        echo "Testing main application endpoint..."
        curl -f http://$INSTANCE_IP/ || exit 1
        
        echo "ðŸš€ Application deployed successfully!"
        echo "Application URL: http://$INSTANCE_IP"
        echo "Health check: http://$INSTANCE_IP/health"
        echo "API info: http://$INSTANCE_IP/api/info"
