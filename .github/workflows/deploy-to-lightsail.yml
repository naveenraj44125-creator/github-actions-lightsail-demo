name: Deploy to AWS Lightsail

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  LIGHTSAIL_INSTANCE_NAME: my-app-instance
  NODE_VERSION: '18'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: app/package-lock.json

    - name: Install dependencies
      working-directory: ./app
      run: npm ci

    - name: Run tests
      working-directory: ./app
      run: npm test

    - name: Build application
      working-directory: ./app
      run: npm run build

  deploy-infrastructure:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    outputs:
      instance_ip: ${{ steps.get-ip.outputs.instance_ip }}
      ssh_private_key: ${{ steps.get-ssh-key.outputs.ssh_private_key }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.5.0

    - name: Terraform Init
      working-directory: ./terraform
      run: terraform init

    - name: Clean up existing resources
      working-directory: ./terraform
      run: |
        # Check if resources exist and clean them up
        echo "Checking for existing resources..."
        
        # Delete existing key pair if it exists
        aws lightsail delete-key-pair --key-pair-name "${{ env.LIGHTSAIL_INSTANCE_NAME }}-key" || echo "Key pair doesn't exist or already deleted"
        
        # Delete existing static IP if it exists
        aws lightsail release-static-ip --static-ip-name "${{ env.LIGHTSAIL_INSTANCE_NAME }}-static-ip" || echo "Static IP doesn't exist or already deleted"
        
        # Delete existing instance if it exists
        aws lightsail delete-instance --instance-name "${{ env.LIGHTSAIL_INSTANCE_NAME }}" || echo "Instance doesn't exist or already deleted"
        
        # Wait a moment for resources to be fully deleted
        sleep 30

    - name: Terraform Plan
      working-directory: ./terraform
      run: terraform plan -out=tfplan

    - name: Terraform Apply
      working-directory: ./terraform
      run: terraform apply -auto-approve tfplan

    - name: Get Lightsail instance IP
      id: get-ip
      run: |
        INSTANCE_IP=$(aws lightsail get-instance --instance-name ${{ env.LIGHTSAIL_INSTANCE_NAME }} --query 'instance.publicIpAddress' --output text)
        echo "instance_ip=$INSTANCE_IP" >> $GITHUB_OUTPUT
        echo "Instance IP: $INSTANCE_IP"

    - name: Get SSH private key
      id: get-ssh-key
      working-directory: ./terraform
      run: |
        SSH_KEY=$(terraform output -raw ssh_private_key)
        echo "ssh_private_key<<EOF" >> $GITHUB_OUTPUT
        echo "$SSH_KEY" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Wait for instance to be ready
      run: |
        echo "Waiting for instance to be ready..."
        sleep 120
        
        # Setup SSH key for this step
        mkdir -p ~/.ssh
        echo "${{ steps.get-ssh-key.outputs.ssh_private_key }}" > ~/.ssh/lightsail_key
        chmod 600 ~/.ssh/lightsail_key
        ssh-keyscan -H ${{ steps.get-ip.outputs.instance_ip }} >> ~/.ssh/known_hosts
        
        # Wait for SSH to be available
        for i in {1..30}; do
          if nc -z ${{ steps.get-ip.outputs.instance_ip }} 22; then
            echo "SSH is ready!"
            break
          fi
          echo "Waiting for SSH... ($i/30)"
          sleep 10
        done
        
        # Wait for user_data script to complete
        echo "Waiting for user_data script to complete..."
        for i in {1..20}; do
          if ssh -i ~/.ssh/lightsail_key -o StrictHostKeyChecking=no ubuntu@${{ steps.get-ip.outputs.instance_ip }} "test -f /var/log/user-data-complete.marker"; then
            echo "User data script completed!"
            break
          elif [ $i -eq 20 ]; then
            echo "Warning: User data script may not have completed"
            ssh -i ~/.ssh/lightsail_key -o StrictHostKeyChecking=no ubuntu@${{ steps.get-ip.outputs.instance_ip }} "tail -20 /var/log/user-data.log" || echo "Could not read user-data log"
          else
            echo "Waiting for user data script... ($i/20)"
            sleep 15
          fi
        done

  deploy-application:
    needs: [test, deploy-infrastructure]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ needs.deploy-infrastructure.outputs.ssh_private_key }}" > ~/.ssh/lightsail_key
        chmod 600 ~/.ssh/lightsail_key
        ssh-keyscan -H ${{ needs.deploy-infrastructure.outputs.instance_ip }} >> ~/.ssh/known_hosts

    - name: Deploy application to Lightsail
      env:
        INSTANCE_IP: ${{ needs.deploy-infrastructure.outputs.instance_ip }}
        GITHUB_SHA: ${{ github.sha }}
        GITHUB_REF_NAME: ${{ github.ref_name }}
        GITHUB_WORKFLOW: ${{ github.workflow }}
        GITHUB_RUN_ID: ${{ github.run_id }}
        GITHUB_ACTOR: ${{ github.actor }}
      run: |
        # Create deployment package
        tar -czf app.tar.gz app/
        
        # Copy application to instance
        scp -i ~/.ssh/lightsail_key -o StrictHostKeyChecking=no app.tar.gz ubuntu@$INSTANCE_IP:/tmp/
        
        # Deploy on the instance
        ssh -i ~/.ssh/lightsail_key -o StrictHostKeyChecking=no ubuntu@$INSTANCE_IP << 'EOF'
          set -e
          
          # Extract application
          cd /tmp
          tar -xzf app.tar.gz
          
          # Stop the application service
          sudo systemctl stop lightsail-demo-app || true
          
          # Ensure directory structure exists
          echo "Creating /var/www directory..."
          sudo mkdir -p /var/www
          sudo chown root:root /var/www
          sudo chmod 755 /var/www
          ls -la /var/
          
          # Verify the app directory exists in /tmp
          echo "Checking extracted files..."
          ls -la /tmp/
          
          # Backup current version if it exists
          if [ -d "/var/www/lightsail-demo-app" ]; then
            echo "Backing up existing application..."
            sudo cp -r /var/www/lightsail-demo-app /var/www/lightsail-demo-app.backup.$(date +%Y%m%d_%H%M%S)
          fi
          
          # Deploy new version
          echo "Deploying new version..."
          sudo rm -rf /var/www/lightsail-demo-app
          sudo mv /tmp/app /var/www/lightsail-demo-app
          sudo chown -R www-data:www-data /var/www/lightsail-demo-app
          
          # Install dependencies
          cd /var/www/lightsail-demo-app
          
          # Ensure npm is available and use full path
          echo "Checking npm installation..."
          which npm
          npm --version
          
          # Use full path to npm or ensure PATH is set correctly
          sudo -u www-data env PATH=$PATH:/usr/bin:/usr/local/bin npm ci --production
          
          # Set environment variables for deployment info
          sudo tee /var/www/lightsail-demo-app/.env > /dev/null << ENVEOF
          NODE_ENV=production
          PORT=3000
          DEPLOY_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          GITHUB_SHA=$GITHUB_SHA
          GITHUB_REF_NAME=$GITHUB_REF_NAME
          GITHUB_WORKFLOW=$GITHUB_WORKFLOW
          GITHUB_RUN_ID=$GITHUB_RUN_ID
          GITHUB_ACTOR=$GITHUB_ACTOR
        ENVEOF
          
          # Update systemd service to use .env file
          sudo tee /etc/systemd/system/lightsail-demo-app.service > /dev/null << SERVICEEOF
        [Unit]
        Description=Lightsail Demo App Node.js Application
        After=network.target

        [Service]
        Type=simple
        User=www-data
        Group=www-data
        WorkingDirectory=/var/www/lightsail-demo-app
        ExecStart=/usr/bin/node server.js
        Restart=always
        RestartSec=10
        EnvironmentFile=/var/www/lightsail-demo-app/.env

        # Logging
        StandardOutput=syslog
        StandardError=syslog
        SyslogIdentifier=lightsail-demo-app

        [Install]
        WantedBy=multi-user.target
        SERVICEEOF
          
          # Reload systemd and start the application
          sudo systemctl daemon-reload
          sudo systemctl enable lightsail-demo-app
          sudo systemctl start lightsail-demo-app
          
          # Restart nginx to ensure proper proxy configuration
          sudo systemctl restart nginx
          
          # Wait a moment for the service to start
          sleep 5
          
          # Check service status
          sudo systemctl status lightsail-demo-app --no-pager
          
          echo "Application deployed successfully!"
        EOF

    - name: Health check
      env:
        INSTANCE_IP: ${{ needs.deploy-infrastructure.outputs.instance_ip }}
      run: |
        echo "Performing health check..."
        
        # Wait for application to fully start
        sleep 15
        
        # Check health endpoint
        for i in {1..10}; do
          if curl -f -s http://$INSTANCE_IP/health; then
            echo "âœ… Health check passed!"
            break
          elif [ $i -eq 10 ]; then
            echo "âŒ Health check failed after 10 attempts"
            exit 1
          else
            echo "Health check attempt $i/10 failed, retrying in 10 seconds..."
            sleep 10
          fi
        done
        
        # Test main endpoint
        echo "Testing main application endpoint..."
        curl -f http://$INSTANCE_IP/ || exit 1
        
        echo "ðŸš€ Application deployed successfully!"
        echo "Application URL: http://$INSTANCE_IP"
        echo "Health check: http://$INSTANCE_IP/health"
        echo "API info: http://$INSTANCE_IP/api/info"
